# Git Merge Helper - 智能分支合并助手

## 简介

这是一个 Claude Code Skill，帮助你安全、自动化地完成 Git 分支合并操作。

## 功能特性

- ✅ 自动创建临时合并分支
- ✅ 智能冲突检测与解决建议
- ✅ 冲突时自动回滚
- ✅ 生成详细的操作日志
- ✅ 安全保护机制
- ✅ **支持批量合并到多个分支**
- ✅ **自动清理过期日志**
- ✅ **差异提前拦截**（无需合并时自动跳过）
- 🚫 **禁止操作 pre/prod 等受保护分支**

## 使用方法

### 方式 1：自然语言触发

在 Claude Code 中直接说：
- "帮我合并到 test"
- "merge helper"
- "合并分支"

### 方式 2：批量合并

- "帮我合并到 test 和 dev"
- "批量合并到 test, feature-1, feature-2"

**⚠️ 受保护分支禁止操作**：pre, prod, production, master-prod, pre-prod

## 新增功能 (v2.1.0)

### 1. 冲突解决建议

检测到冲突时，自动提供：
- 📊 冲突统计（文件数、冲突块数）
- 💡 针对不同文件类型的解决建议
- 🔧 常用冲突解决命令
- 📝 详细报告记录到日志

### 2. 批量合并

一次合并到多个分支：
```
你: 帮我合并到 test 和 dev

AI: 🔍 预检 2 个分支...
    --------------------------------------------------
    ✅ test: 预检通过
    ✅ dev: 预检通过
    --------------------------------------------------
    ✅ 预检通过，开始批量合并...
    目标分支: test, dev
    --------------------------------------------------
    [1/2] 合并到 test...
    ✅ SUCCESS
    [2/2] 合并到 dev...
    ✅ SUCCESS
    ==================================================
    📊 批量合并结果汇总:
      ✅ test: SUCCESS
      ✅ dev: SUCCESS
    成功: 2/2
```

### 3. 自动日志清理

每次合并后自动清理旧日志：
- 一周内最多保留 10 个
- 一个月内最多保留 5 个
- 超过一个月的全部删除

### 4. 全面 Git 状态检查 (v2.1.0 新增)

检测各种 Git 状态异常：
- Submodule 变更
- LFS 锁定文件
- Assume-unchanged 文件
- 常规文件变更

提供针对性清理建议。

### 5. 网络重试机制 (v2.1.0 新增)

- 自动识别网络错误（超时、连接拒绝等）
- 3 次重试，递增延迟（2秒、4秒、6秒）
- 记录重试次数到日志

### 6. 批量合并预检 (v2.1.0 新增)

- 执行前预检所有分支
- 验证远程分支存在性
- 检查推送权限
- 全部成功或全部失败

### 7. 配置文件支持 (v2.2.0 新增)

- 所有硬编码值可通过配置文件自定义
- 配置文件：`.claude/skills/git-merge-helper/config.json`
- 支持的配置项：
  - 网络重试次数和延迟
  - 日志清理策略
  - 受保护分支列表
  - 文件大小限制

### 8. 并发保护 (v2.2.0 新增)

- 使用文件锁防止同时执行多个合并
- 避免状态冲突和临时分支冲突
- 提示用户等待其他合并完成

### 9. 详细恢复指导 (v2.2.0 新增)

- 回滚失败时提供 6 步手动恢复指南
- 帮助用户处理不确定状态
- 包含完整的 Git 命令示例

### 10. 大文件保护 (v2.2.0 新增)

- 超过限制的冲突文件提示手动处理
- 默认限制 10MB，可通过配置修改
- 避免加载大文件导致内存问题

## 使用前准备

1. **确保工作目录干净**
   ```bash
   git status
   ```
   .DS_Store 和 .claude 目录会被自动忽略

2. **确保在 Git 仓库中**
   ```bash
   git branch --show-current
   ```

## 合并流程

1. 检查环境
2. 检查差异（提前拦截）
3. 选择目标分支
4. 创建临时分支
5. 执行合并
6. 检测冲突
   - 有冲突：生成解决建议 → 自动回滚
   - 无冲突：完成合并
7. 自动清理旧日志

## Python 脚本

Skill 包含了 10 个 Python 辅助脚本：

| 脚本 | 功能 |
|------|------|
| `config.py` | 配置管理器（加载/保存配置）|
| `logger.py` | 日志记录器（支持自动清理）|
| `branch_selector.py` | 分支选择器（交互式/非交互式）|
| `conflict_checker.py` | 冲突检测器 |
| `conflict_resolver.py` | 冲突解决建议器 |
| `merge_prechecker.py` | 合并预检器（远程分支验证）|
| `git_status_checker.py` | Git 状态检查器（全面检测）|
| `git_network_helper.py` | 网络操作辅助类（重试机制）|
| `log_cleaner.py` | 日志清理器 |
| `merge_executor.py` | 合并执行器（集成所有功能）|

### 使用方式

```bash
# 单分支合并
python3 .claude/skills/git-merge-helper/scripts/merge_executor.py test

# 查看分支列表
python3 .claude/skills/git-merge-helper/scripts/branch_selector.py

# 测试日志清理
python3 .claude/skills/git-merge-helper/scripts/log_cleaner.py
```

## 输出文件

日志文件保存在：`.claude/logs/`，文件名格式：

**单分支合并：**
```
merge-[源分支]-to-[目标分支]-YYYYMMDD-HHMMSS.log
```
例如：`merge-[feature-new-feature]-to-[test]-20260104-141544.log`

**批量合并：**
```
merge-batch-[Nbranches]-YYYYMMDD-HHMMSS.log
```
例如：`merge-batch-[3branches]-20260104-141544.log`

## 注意事项

- ⚠️ 工作目录必须干净（无未提交更改）
- ⚠️ pre/prod 分支禁止操作
- ⚠️ 冲突时会自动回滚，建议按日志提示处理
- ⚠️ 确保有推送权限

## 示例

### 成功合并

```
你: 帮我合并到 test

AI: 好的，让我开始合并流程...
    ✓ 检测到 1 个新提交需要合并
    ✓ 无冲突
    ✅ 成功合并到 test 分支
    📝 日志已保存
```

### 遇到冲突

```
你: 帮我合并到 test

AI: 🔴 检测到 2 个文件有冲突
    📊 共 3 个冲突块

    📋 冲突分析报告
    ==================================================
    冲突文件数: 2
    冲突块总数: 3

    详细分析:

    📄 src/main/java/UserService.java (Java)
       检测到 2 个冲突块
       💡 解决建议:
          1. 打开文件，搜索 <<<<<<< 找到冲突位置
          2. 检查 Java 语法：确保合并后代码可编译
          ...

    ⚠️  已自动回滚，请参考上方建议手动处理冲突
```

### 批量合并

```
你: 帮我合并到 test 和 env

AI: 🔄 开始批量合并到 2 个分支...
    目标分支: test, env
    --------------------------------------------------
    [1/2] 合并到 test...
    ✅ SUCCESS
    [2/2] 合并到 env...
    ✅ SUCCESS
    ==================================================
    📊 批量合并结果汇总:
      ✅ test: SUCCESS
      ✅ env: SUCCESS
    成功: 2/2
```

### 尝试操作受保护分支

```
你: 帮我合并到 pre 和 prod

AI: ❌ 禁止操作受保护分支: pre, prod
    受保护分支列表: pre, prod, production, master-prod, pre-prod
```

## 更新日志

### v2.2.0 (2026-01-04)
- 🐛 修复：assume-unchanged 文件检测逻辑错误
  - 之前错误地跳过了小写 `h` 标记的文件
  - 现在正确检测 assume-unchanged 状态
- 🐛 修复：受保护分支误杀问题
  - `feature/pre-fix` 等合法分支不再被误阻止
  - 使用精确匹配 + 常见变体匹配
- ✨ 新增：配置文件支持
  - 创建 `config.py` 配置管理器
  - 创建 `config.json` 默认配置文件
  - 所有硬编码值现在可自定义
- ✨ 新增：并发保护机制
  - 使用文件锁防止同时执行多个合并
  - 避免状态冲突和临时分支冲突
- ✨ 新增：详细恢复指导
  - 回滚失败时提供 6 步手动恢复指南
  - 帮助用户处理不确定状态
- ✨ 新增：大文件保护
  - 超过限制的冲突文件提示手动处理
  - 默认限制 10MB，可配置
- 🔧 优化：网络错误关键词扩展
  - 添加 DNS、SSL、handshake 等错误识别
  - 提高网络重试成功率
- 🔧 优化：项目根目录检测
  - 不在 Git 仓库时抛出清晰错误
  - 避免遍历到系统根目录

### v2.1.0 (2026-01-04)
- ✨ 新增：全面 Git 状态检查
  - Submodule 变更检测
  - LFS 锁定文件检测
  - Assume-unchanged 文件检测
  - 提供针对性清理建议
- ✨ 新增：网络重试机制
  - 3 次重试，递增延迟（2秒、4秒、6秒）
  - 自动识别网络错误类型
  - 记录重试次数到日志
- ✨ 新增：批量合并预检
  - 执行前预检所有分支
  - 验证远程分支存在性
  - 检查推送权限
  - 全部成功或全部失败模式
- 🔧 优化：branch_selector 支持非交互式模式
- 📝 新增：merge_prechecker.py 脚本
- 📝 新增：git_status_checker.py 脚本
- 📝 新增：git_network_helper.py 脚本

### v2.0.0 (2026-01-04)
- ✨ 新增：冲突解决建议
  - 根据文件类型提供针对性建议
  - 包含常用解决命令
  - 详细报告记录到日志
- ✨ 新增：批量合并到多个分支
- ✨ 新增：受保护分支检查（禁止 pre/prod）
- ✨ 新增：自动日志清理
  - 一周内最多 10 个
  - 一个月内最多 5 个
- 🔧 优化：环境检查过滤 .DS_Store 和 .claude
- 📝 新增：conflict_resolver.py 脚本
- 📝 新增：log_cleaner.py 脚本
- 📝 新增：WORKFLOW.md 流程文档

### v1.1.0 (2026-01-04)
- ✨ 新增：差异提前拦截
- ✨ 新增：4 个 Python 辅助脚本

### v1.0.0 (2026-01-04)
- 初始版本

