# Git Merge Helper - 详细流程图

## 完整工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户触发 Skill                            │
│                                                                 │
│  自然语言: "帮我合并到 test" / "合并分支" / "merge helper"       │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第 1 步：检查环境（增强版）                                     │
├─────────────────────────────────────────────────────────────────┤
│  执行: git status --porcelain                                   │
│                                                                 │
│  过滤: .DS_Store, .claude 目录                                  │
│                                                                 │
│  检查特殊状态:                                                  │
│  - Submodule 变更 (git submodule status)                        │
│  - LFS 锁定文件 (git lfs status)                                │
│  - Assume-unchanged (git ls-files -v)                          │
│                                                                 │
│  ┌────────────────┐                                            │
│  │ 有异常状态?    │──Yes──▶ ❌ 提供详细建议并退出                 │
│  └────────┬───────┘       - Submodule: git submodule update    │
│           │No               - LFS: git lfs unlock               │
│           ▼                 - Assume: git update-index --no...  │
│      ✅ 工作目录干净                                            │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第 2 步：获取分支信息                                           │
├─────────────────────────────────────────────────────────────────┤
│  执行: git branch --show-current  → 获取当前分支                │
│  执行: git branch -r              → 获取所有远程分支            │
│                                                                 │
│  当前分支: WMS00.00.02T/feat_ai_ding_notify_ljc_20251224        │
│  可用分支: [test, master, env_pre, feat_*, ...]                 │
│                                                                 │
│  ⚠️  当前分支: 自动检测，不询问用户                             │
│  ⚠️  目标分支: 用户指定 或 交互式选择                           │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第 3 步：选择目标分支                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────┐               │
│  │ 用户指定了目标分支? (如 /merge-helper test)         │               │
│  └────────┬────────────────────────────────────┘               │
│           │                                                     │
│     ┌─────┴─────┐                                               │
│     │           │                                               │
│   Yes          No                                               │
│     │           │                                               │
│     ▼           ▼ 显示所有分支列表                              │
│  直接使用    ┌─────────────────────────────────┐               │
│             │ 1. test                          │               │
│             │ 2. master                        │               │
│             │ 3. env_pre                       │               │
│             │ ...                              │               │
│             │ 16. feat_1_6_0_common            │               │
│             └─────────────────────────────────┘               │
│                       用户选择 (输入数字或分支名)                │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第 4 步：检查差异 (提前拦截)                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  执行: git log test..HEAD --oneline                             │
│                                                                 │
│  ┌────────────────────────────────────┐                         │
│  │ 有新提交需要合并?                   │                         │
│  └────┬───────────────────────────────┘                         │
│       │                                                           │
│   No  │  ✅ 无需合并                                              │
│   ├──┼─────────────────────────────────────────────────────────▶ │
│   │   │  当前分支的所有更改已经在 test 分支中了                   │
│   │   │  生成 SKIP 日志并退出                                    │
│   │   │                                                          │
│   │ Yes                                                          │
│   │   │                                                          │
│   │   ▼                                                          │
│   │   检测到 N 个新提交需要合并                                  │
│   │   显示最新提交列表                                          │
│   │   └─ d059e7a3d docs(alarm): 添加 LogAlarmProxy 弃用注释     │
│   │   └─ ...                                                    │
│   └──┴                                                          │
└─────────────────────────────┬───────────────────────────────────┘
                              │ (需要合并)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第 5 步：创建临时分支                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  生成临时分支名:                                                 │
│  merge-{source}-to-{target}-{timestamp}                          │
│                                                                 │
│  例如: merge-WMS00.00.02T_feat_ai_ding_notify_ljc_20251224      │
│             -to-test-20260104-130939                            │
│                                                                 │
│  执行: git checkout -b {temp_branch} {target_branch}            │
│                                                                 │
│  ✅ 临时分支创建成功                                            │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第 6 步：拉取目标分支最新代码（网络重试机制）                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  执行: git pull origin {target_branch}                          │
│                                                                 │
│  网络重试机制:                                                  │
│  - 最大重试次数: 3 次                                           │
│  - 重试延迟: 2秒、4秒、6秒（递增）                              │
│  - 自动识别: 超时、连接拒绝、主机未找到等                       │
│                                                                 │
│  可能结果:                                                       │
│  - Already up to date. (已最新)                                │
│  - Updating {hash}..{hash} (有更新)                            │
│  - 网络错误 → 自动重试 → 成功/失败                              │
│                                                                 │
│  ✅ 代码已同步（记录重试次数到日志）                            │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第 7 步：合并当前分支到临时分支                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  执行: git merge {current_branch} --no-edit --no-ff             │
│                                                                 │
│  --no-edit   : 使用默认提交消息，不打开编辑器                    │
│  --no-ff     : 不使用快进合并，总是创建合并提交                  │
│                                                                 │
│  ✅ 合并执行完成                                                │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第 8 步：检测冲突                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  执行: git diff --name-only --diff-filter=U                     │
│                                                                 │
│  ┌────────────────────────────────────────┐                    │
│  │ 有冲突文件?                             │                    │
│  └────┬───────────────────────────────────┘                    │
│       │                                                           │
│   No  │                                                           │
│   ├──┼─────────────────────────────────────────────────────────▶ │
│   │   │  进入 "无冲突流程"                                      │
│   │   │                                                          │
│   │ Yes                                                          │
│   │   │                                                          │
│   │   ▼                                                          │
│   │   进入 "冲突回滚流程"                                       │
│   │   └─ 记录冲突文件列表                                       │
│   └──┴                                                          │
└─────────────────────────────┬───────────────────────────────────┘
                              │
              ┌───────────────┴────────────────┐
              │                                │
              ▼                                ▼
    ┌───────────────────┐          ┌───────────────────┐
    │   无冲突流程       │          │  冲突回滚流程      │
    └───────────────────┘          └───────────────────┘
              │                                │
              ▼                                ▼
    ┌───────────────────┐          ┌─────────────────────┐
    │ 推送临时分支       │          │ git merge --abort   │
    │ git push origin   │          │ (中止合并)          │
    │ {temp_branch}     │          └─────────────────────┘
    └───────────────────┘                  │
              │                            ▼
              ▼                  ┌─────────────────────┐
    ┌───────────────────┐          │ 切换回原分支        │
    │ 切换到目标分支     │          │ git checkout       │
    │ git checkout      │          │ {current_branch}    │
    │ {target_branch}   │          └─────────────────────┘
    └───────────────────┘                  │
              │                            ▼
              ▼                  ┌─────────────────────┐
    ┌───────────────────┐          │ 删除临时分支        │
    │ 合并临时分支       │          │ git branch -D      │
    │ git merge         │          │ {temp_branch}      │
    │ {temp_branch}     │          └─────────────────────┘
    │ --no-edit         │                  │
    └───────────────────┘                  ▼
              │                  ┌─────────────────────┐
              ▼                  │ 生成 FAILED 日志    │
    ┌───────────────────┐          │ 状态: CONFLICTS     │
    │ 推送目标分支       │          │ 原因: 检测到冲突    │
    │ git push origin   │          │ 已自动回滚         │
    │ {target_branch}   │          └─────────────────────┘
    └───────────────────┘                  │
              │                            ▼
              ▼                  ┌─────────────────────┐
    ┌───────────────────┐          │ 提示用户手动处理    │
    │ 删除本地临时分支   │          │ 冲突文件:          │
    │ git branch -D     │          │ - file1.java       │
    │ {temp_branch}     │          │ - file2.yml        │
    └───────────────────┘          │                    │
              │                    │ 请手动解决后重试   │
              ▼                  └─────────────────────┘
    ┌───────────────────┐
    │ 删除远程临时分支   │
    │ git push origin   │
    │ --delete          │
    │ {temp_branch}     │
    └───────────────────┘
              │
              ▼
    ┌───────────────────┐
    │ 切换回原分支       │
    │ git checkout      │
    │ {current_branch}  │
    └───────────────────┘
              │
              ▼
    ┌───────────────────┐
    │ 生成 SUCCESS 日志  │
    │ 状态: SUCCESS      │
    │ 已合并到 test      │
    └───────────────────┘
              │
              ▼
    ┌───────────────────┐
    │ 完成！            │
    │ 日志已保存:       │
    │ .claude/logs/     │
    │ merge_*.log       │
    └───────────────────┘
```

## 日志文件示例

### 成功日志

```log
合并日志 - 2026-01-04 13:09:44
============================================================
当前分支:    WMS00.00.02T/feat_ai_ding_notify_ljc_20251224
目标分支:    test
临时分支:    merge-WMS00.00.02T-to-test-20260104-130939
状态:        SUCCESS
耗时:        4.79 seconds

操作步骤：
[13:09:39.537] ✓ 检查环境
  > 工作目录干净
[13:09:39.537] ✓ 获取分支信息
  > 当前: WMS00.00.02T/feat_ai_ding_notify_ljc_20251224, 可用: 16 个
[13:09:39.553] ✓ 检测到 1 个新提交需要合并
  > 最新提交: d059e7a3d docs(alarm): 添加 LogAlarmProxy 弃用注释
[13:09:39.649] ✓ 创建临时分支
  > merge-WMS00.00.02T-to-test-20260104-130939
[13:09:40.477] ✓ 拉取 test 分支最新代码
  > Already up to date.
[13:09:40.560] ✓ 合并 WMS00.00.02T/feat_ai_ding_notify_ljc_20251224 分支
  > 1 file changed
[13:09:40.576] ✓ 检测冲突
  > 无冲突
[13:09:42.985] ✓ 推送 test 分支
  > 已合并到 test
[13:09:44.211] ✓ 清理临时分支
  > merge-WMS00.00.02T-to-test-20260104-130939
[13:09:44.229] ✓ 返回原分支
  > WMS00.00.02T/feat_ai_ding_notify_ljc_20251224
```

### 冲突回滚日志

```log
合并日志 - 2026-01-04 15:20:00
============================================================
当前分支:    feature/user-service
目标分支:    test
状态:        FAILED (CONFLICTS)
耗时:        5.2 seconds

操作步骤：
[15:20:00] ✓ 检查环境
[15:20:01] ✓ 获取分支信息
[15:20:02] ✓ 检测到 2 个新提交需要合并
[15:20:03] ✓ 创建临时分支
[15:20:04] ✓ 合并 feature/user-service 分支
[15:20:05] ✗ 检测到 2 个冲突文件
  > src/main/java/UserService.java
  > src/main/resources/application.yml
[15:20:05] ⚠️  开始自动回滚
[15:20:06] ✓ 已切换回原分支
  > feature/user-service
```

### 跳过合并日志

```log
合并日志 - 2026-01-04 13:22:18
============================================================
当前分支:    WMS00.00.02T/feat_ai_ding_notify_ljc_20251224
目标分支:    test
状态:        SKIP
原因:        无需合并
耗时:        0.10 seconds

操作步骤：
[13:22:18.445] ✓ 检查环境
  > 工作目录干净
[13:22:18.445] ✓ 获取分支信息
  > 当前: WMS00.00.02T/feat_ai_ding_notify_ljc_20251224, 可用: 16 个
[13:22:18.464] ⚠️  没有需要合并的新内容
  > 当前分支的所有更改已经在 test 分支中了
```

## 核心设计要点

### 1. 安全性
- ✅ **临时分支**：不在原分支直接操作
- ✅ **冲突回滚**：检测到冲突立即恢复
- ✅ **环境检查**：确保工作目录干净

### 2. 用户体验
- ✅ **提前拦截**：无需合并时直接跳过
- ✅ **自动检测**：当前分支自动识别，无需选择
- ✅ **详细日志**：所有操作都有记录

### 3. 智能过滤
- ✅ **忽略 .DS_Store**：macOS 系统文件
- ✅ **忽略 .claude/**：Skill 配置目录
- ✅ **只显示有意义的状态**

## 使用方式

### 自然语言触发（推荐）
```
"帮我合并到 test"
"合并分支"
"merge helper"
```

### 直接运行脚本
```bash
python3 .claude/skills/git-merge-helper/scripts/merge_executor.py test
```

## 文件结构

```
.claude/skills/git-merge-helper/
├── SKILL.md               # Skill 定义（触发词、权限等）
├── WORKFLOW.md            # 流程文档（本文件）
├── README.md              # 使用说明
└── scripts/
    ├── config.py          # 配置管理器
    ├── config.json        # 默认配置文件
    ├── merge_executor.py  # 主执行器（集成所有功能）
    ├── logger.py          # 日志记录器
    ├── branch_selector.py # 分支选择器（交互式/非交互式）
    ├── conflict_checker.py# 冲突检测器
    ├── conflict_resolver.py# 冲突解决建议器
    ├── merge_prechecker.py # 合并预检器
    ├── git_status_checker.py # Git 状态检查器
    ├── git_network_helper.py # 网络操作辅助类
    └── log_cleaner.py     # 日志清理器
```

## 配置文件

配置文件位置：`.claude/skills/git-merge-helper/scripts/config.json`

### 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `max_retries` | 3 | 网络操作最大重试次数 |
| `retry_delay` | 2 | 基础重试延迟（秒） |
| `network_timeout` | 30 | 网络操作超时时间（秒） |
| `max_week_logs` | 10 | 一周内最多保留的日志数 |
| `max_month_logs` | 5 | 一个月内最多保留的日志数 |
| `week_days` | 7 | 一周天数 |
| `month_days` | 30 | 一个月天数 |
| `protected_branches` | [...] | 受保护分支列表 |
| `max_conflict_file_size` | 10485760 | 冲突文件最大大小（字节） |

### 修改配置

编辑 `.claude/skills/git-merge-helper/scripts/config.json` 文件即可。

## 权限配置

`.claude/settings.local.json`
```json
{
  "permissions": {
    "allow": [
      "Bash(git:*)",
      "Bash(python3:.claude/skills/*/scripts/*)",
      "Bash(python3:*)",
      "Read(.claude/**)",
      "Write(.claude/**)",
      "Edit(.claude/**)"
    ]
  }
}
```
